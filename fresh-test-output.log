
> sartor-memory-system@1.0.0 test
> jest --testPathPattern=rate-limiter --no-cache

FAIL src/multi-expert/__tests__/rate-limiter.test.ts (25.572 s)
  TokenBucketRateLimiter
    Configuration and Initialization
      ✓ creates with default config (2 ms)
      ✓ creates with custom config (1 ms)
      ✓ initializes with full token bucket
    Token Bucket Algorithm
      ✓ consumes tokens when executing request (1 ms)
      ✓ refills tokens over time (101 ms)
      ✓ does not exceed max burst capacity (100 ms)
      ✓ queues requests when insufficient tokens (501 ms)
    Priority Queue
      ✕ processes higher priority requests first (402 ms)
      ✓ clamps priority to max level (1 ms)
    Queue Management
      ✕ drops requests when queue is full (11238 ms)
      ✓ clears all queued requests (1 ms)
    Pause and Resume
      ✓ pauses and resumes processing (50 ms)
      ✓ does not refill tokens while paused (50 ms)
    Statistics
      ✓ tracks total requests
      ✓ tracks total tokens consumed
      ✕ tracks dropped requests (10001 ms)
      ✓ calculates average wait time (301 ms)
    Request Validation
      ✓ rejects request without id (5 ms)
      ✓ rejects request with negative priority
      ✓ rejects request with non-positive tokens (2 ms)
      ✓ rejects request without callback
    Error Handling
      ✓ propagates callback errors (1 ms)
      ✓ continues processing after error (2 ms)
  SimpleCostTracker
    Cost Tracking
      ✓ tracks cost for single expert
      ✓ tracks cost for multiple experts
      ✓ accumulates cost for same expert
      ✓ tracks tokens separately from cost (1 ms)
    Budget Management
      ✓ initializes with no budget by default (1 ms)
      ✓ initializes with budget (1 ms)
      ✓ detects when over budget
      ✓ sets budget after initialization
      ✓ rejects negative budget (1 ms)
    Utility Methods
      ✓ resets all tracking (1 ms)
      ✓ getCostByExpert returns copy
      ✓ getTokensByExpert returns token breakdown
  Factory Functions
    ✓ createRateLimiter creates instance
    ✓ createRateLimiter accepts config
    ✓ createCostTracker creates instance (1 ms)
    ✓ createCostTracker accepts budget
  Integration Tests
    ✓ rate limiter with cost tracker
    ✓ handles budget exceeded scenario
    ✓ concurrent expert execution with rate limiting (500 ms)

  ● TokenBucketRateLimiter › Priority Queue › processes higher priority requests first

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   2

      168 |
      169 |       // Higher priority should execute earlier
    > 170 |       expect(executionOrder.indexOf(4)).toBeLessThan(executionOrder.indexOf(2));
          |                                         ^
      171 |       expect(executionOrder.indexOf(2)).toBeLessThan(executionOrder.indexOf(0));
      172 |     }, 10000);
      173 |

      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:170:41)

  ● TokenBucketRateLimiter › Queue Management › drops requests when queue is full

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      188 |
      189 |   describe('Queue Management', () => {
    > 190 |     test('drops requests when queue is full', async () => {
          |     ^
      191 |       const limiter = new TokenBucketRateLimiter({
      192 |         tokensPerSecond: 100,
      193 |         maxBurst: 100,

      at src/multi-expert/__tests__/rate-limiter.test.ts:190:5
      at src/multi-expert/__tests__/rate-limiter.test.ts:189:3
      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:15:1)

  ● TokenBucketRateLimiter › Statistics › tracks dropped requests

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      345 |     });
      346 |
    > 347 |     test('tracks dropped requests', async () => {
          |     ^
      348 |       const limiter = new TokenBucketRateLimiter({
      349 |         tokensPerSecond: 100,
      350 |         maxBurst: 100,

      at src/multi-expert/__tests__/rate-limiter.test.ts:347:5
      at src/multi-expert/__tests__/rate-limiter.test.ts:304:3
      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:15:1)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 39 passed, 42 total
Snapshots:   0 total
Time:        25.775 s
Ran all test suites matching /rate-limiter/i.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
Terminated
