
> sartor-memory-system@1.0.0 test
> jest --testPathPattern=rate-limiter

FAIL src/multi-expert/__tests__/rate-limiter.test.ts (66.512 s)
  TokenBucketRateLimiter
    Configuration and Initialization
      ✓ creates with default config (3 ms)
      ✓ creates with custom config
      ✓ initializes with full token bucket
    Token Bucket Algorithm
      ✓ consumes tokens when executing request (1 ms)
      ✓ refills tokens over time (101 ms)
      ✓ does not exceed max burst capacity (101 ms)
      ✓ queues requests when insufficient tokens (501 ms)
    Priority Queue
      ✕ processes higher priority requests first (402 ms)
      ✓ clamps priority to max level
    Queue Management
      ✕ drops requests when queue is full (31269 ms)
      ✓ clears all queued requests (1 ms)
    Pause and Resume
      ✓ pauses and resumes processing (50 ms)
      ✓ does not refill tokens while paused (50 ms)
    Statistics
      ✓ tracks total requests
      ✓ tracks total tokens consumed (1 ms)
      ✕ tracks dropped requests (31287 ms)
      ✓ calculates average wait time (200 ms)
    Request Validation
      ✓ rejects request without id (5 ms)
      ✓ rejects request with negative priority
      ✓ rejects request with non-positive tokens (1 ms)
      ✓ rejects request without callback (1 ms)
    Error Handling
      ✓ propagates callback errors (1 ms)
      ✓ continues processing after error
  SimpleCostTracker
    Cost Tracking
      ✓ tracks cost for single expert
      ✓ tracks cost for multiple experts (1 ms)
      ✓ accumulates cost for same expert (1 ms)
      ✓ tracks tokens separately from cost
    Budget Management
      ✓ initializes with no budget by default
      ✓ initializes with budget
      ✓ detects when over budget (1 ms)
      ✓ sets budget after initialization
      ✓ rejects negative budget (1 ms)
    Utility Methods
      ✓ resets all tracking
      ✓ getCostByExpert returns copy (1 ms)
      ✓ getTokensByExpert returns token breakdown
  Factory Functions
    ✓ createRateLimiter creates instance
    ✓ createRateLimiter accepts config
    ✓ createCostTracker creates instance
    ✓ createCostTracker accepts budget
  Integration Tests
    ✓ rate limiter with cost tracker (1 ms)
    ✓ handles budget exceeded scenario
    ✓ concurrent expert execution with rate limiting (401 ms)

  ● TokenBucketRateLimiter › Priority Queue › processes higher priority requests first

    expect(received).toBeLessThan(expected)

    Expected: < 1
    Received:   2

      168 |
      169 |       // Higher priority should execute earlier
    > 170 |       expect(executionOrder.indexOf(4)).toBeLessThan(executionOrder.indexOf(2));
          |                                         ^
      171 |       expect(executionOrder.indexOf(2)).toBeLessThan(executionOrder.indexOf(0));
      172 |     }, 10000);
      173 |

      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:170:41)

  ● TokenBucketRateLimiter › Queue Management › drops requests when queue is full

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      188 |
      189 |   describe('Queue Management', () => {
    > 190 |     test('drops requests when queue is full', async () => {
          |     ^
      191 |       const limiter = new TokenBucketRateLimiter({
      192 |         tokensPerSecond: 10,
      193 |         maxBurst: 10,

      at src/multi-expert/__tests__/rate-limiter.test.ts:190:5
      at src/multi-expert/__tests__/rate-limiter.test.ts:189:3
      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:15:1)

  ● TokenBucketRateLimiter › Statistics › tracks dropped requests

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      342 |     });
      343 |
    > 344 |     test('tracks dropped requests', async () => {
          |     ^
      345 |       const limiter = new TokenBucketRateLimiter({
      346 |         tokensPerSecond: 10,
      347 |         maxBurst: 10,

      at src/multi-expert/__tests__/rate-limiter.test.ts:344:5
      at src/multi-expert/__tests__/rate-limiter.test.ts:301:3
      at Object.<anonymous> (src/multi-expert/__tests__/rate-limiter.test.ts:15:1)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 39 passed, 42 total
Snapshots:   0 total
Time:        66.702 s, estimated 67 s
Ran all test suites matching /rate-limiter/i.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
